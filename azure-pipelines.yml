trigger:
  branches:
    include:
    - main

schedules:
- cron: "30 14 * * *"  # 8:00 PM IST (2:30 PM UTC)
  displayName: Daily 8 PM IST Test Run
  branches:
    include:
    - main
  always: true

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: powerbi-test-secrets

steps:
- task: NodeTool@0
  displayName: 'Install Node.js'
  inputs:
    versionSpec: '20.x'

- script: npm ci
  displayName: 'Install dependencies'

- script: npx playwright install --with-deps chromium
  displayName: 'Install Playwright browsers'

- script: npm test
  displayName: 'Run Power BI Tests'
  env:
    CLIENT_ID: $(CLIENT_ID)
    TENANT_ID: $(TENANT_ID)
    # CLIENT_SECRET: $(CLIENT_SECRET)
    # AZURE_CLIENT_SECRET: $(CLIENT_SECRET)
    FEDERATED_CREDENTIAL_NAME: $(FEDERATED_CREDENTIAL_NAME)
    ENVIRONMENT: $(ENVIRONMENT)
    TEAMS_WEBHOOK_URL: $(TEAMS_WEBHOOK_URL)

- task: PowerShell@2
  displayName: 'Send Teams Notification'
  condition: always()
  inputs:
    targetType: 'filePath'
    filePath: './send-teams-notification.ps1'
  env:
    TEAMS_WEBHOOK_URL: $(TEAMS_WEBHOOK_URL)

- task: PublishTestResults@2
  displayName: 'Publish Test Results'
  condition: always()
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: 'test-results/results.xml'
    failTaskOnFailedTests: false

- task: PublishPipelineArtifact@1
  displayName: 'Publish Test Reports'
  condition: always()
  inputs:
    targetPath: 'playwright-report'
    artifact: 'playwright-report'
    publishLocation: 'pipeline'
